<!doctype html>
<meta charset="utf-8">
<link rel="stylesheet" href="../../../static/style.css">
<title>Blog — Gergelim</title>
<body>
  <header>
    <h1>Gergelim</h1>
    <nav>
      <ul class="nav navbar-nav">
        <li><a href="../../../">Welcome</a></li>
        
          <li class="active"><a href="../../">Blog</a></li>
        
          <li><a href="../../../projects/">Projects</a></li>
        
          <li><a href="../../../about/">About</a></li>
        
      </ul>
    </nav>
  </header>
  <div class="page">
    
  
    
  <div class="blog-post">
  
    <h2><a href="../../kicking-the-tires/">Kicking the Tires</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2015-10-25
  </p>
  <p>In the hot, cruel desert of this space, wind howled in solitude. A stone statue lay on the ground like a man asleep, succumbing to its own weight, mental and physical. For more than one year, no stirring. The sun shines on again today. A wanderer passes by on a camel, and looks at the strange statue. He swears that he saw it moving.</p>
<!-- more -->

<p>I haven't written a word on this blog for more than one year. I figured it was high time to make some effort to hammer it back into shape.</p>
<h2>The long hiatus, and why it grew so strong</h2>
<p>I have spent some time thinking about the reasons for which I stopped updating the content. Laziness is a reason, of course; but also something deeper.</p>
<p>I had designed this blog in 2013 with the help of a good book, Antonio Cangiano's <a href="https://www.amazon.co.uk/gp/product/1934356883/">Technical Blogging</a>. I idolized his words (as alas I do too often with too many maîtres à penser), and wanted to faithfully follow them. Now don't take me wrong, I still think highly of Antonio as a colleague; only I came to the conclusion that his book was not really meant to suggest me this particular strategy, but that it was me instead who interpreted it that way.</p>
<p>One of his pieces of advice was to focus on one topic; and I decided, since for some obscure and uncontrollable fate I was knee-deep into C++, to write about that. The twist, since I recognize my lack of experience and expertise, was that I wanted to use the blog to document my findings and my efforts, and to be held accountable of some amount of progress, however marginal, but unstoppable. Ah that, that I love. <em>Constant growth</em>.</p>
<p>But then, expectedly, unexpected happened. I started having a hard time at work, from lack of challenges, among other boring things. And so C++ became, in my eye, the tool that I used during my daily job, and that I associated with the hard time and the stress and a lot of things which have nothing to do with the technology itself, but made me respect it less as a scaffold to build my spirit in the time I've got to strengthen my knowledge (because it is this I do every moment).</p>
<h2>Make it right</h2>
<p>I mixed two parts of reading and one part of living, and at some point I saw the truth. I was not growing. I was stuck for some reason; of course, I was missing out on the blog being an instrument of improvement, but I didn't mind that at the moment. I was not growing because I was not explicitly planning for it. Because I was not fighting to make it happen, letting it go, for whatever definition of <em>it</em>. I needed to rebuild a sustainable process of growth, from its foundations. The spark of this revolution, by the way, was a talk at the ACCU conference, with the apt name <a href="https://www.slideshare.net/petegoodliffe/becoming-a-better-programmer-47411490">Becoming a Better Programmer</a>, by <a href="https://www.goodliffe.net/">Pete Goodliffe</a>.</p>
<p>So I started thinking of a process to engineer improvement back into my day. I remembered reading something like Do 3 or 4 things, every day, for 12 weeks; then measure and adapt. I think it was Seth Godin, but later wasn't able to find out. I needed to adapt this process to a day without predictable time tables, by making a very few assumptions; two, to be precise:</p>
<ol>
<li>I know when I enter the office, but I can't be sure when I get out</li>
<li>I want to make sports to be mentally efficient</li>
</ol>
<p>I started with 2 things, then improved on that. So far it is going well. I use <a href="https://toggl.com/">Toggl</a> for time tracking, but this is just a detail. (It is serving me well though).</p>
<p>I manage to squeeze 2 45-minutes blocks, which I assign to an activity each; currently, it is reading <a href="https://www.amazon.co.uk/gp/product/013409266X/">Computer Systems: A Programmer's Perspective</a> and learning <a href="https://racket-lang.org/">Racket</a>. I have started on August 24, 2015, and November 8 will mark the 12 weeks milestone, at which point I will measure the experience. I could not wait until then to squeeze in some other activity, and in my case, I kindly vexed myself with an additional 30-minute block a day of reading Josuttis' <a href="https://www.amazon.co.uk/gp/product/0321623215/">tutorial on the C++ Standard Library</a>.</p>
<h2>Thoughts</h2>
<p>This is a plan; sometimes, I don't manage to follow it. But it is definitely better to have plan than not to, so I'll stick with this, and only change my mind every 3 months or so. This helps me keep my focus, and not being drained away by all the shiny stuff I run into. It also helps me <a href="https://www.bothsidesofthetable.com/2015/06/19/why-successful-people-focus-on-the-bottom-end-of-the-funnel/">arrive at the end of the funnel</a>.</p>
<p><em>This is about my growth as an engineer</em>. One language does not define my activity; and I want to describe exactly that, the struggle, and not only presenting in my own way the results, that can be found in books.</p>
<p>This blog is part of a larger project, <a href="https://www.gergel.im/">Gergelim</a>, which is my attempt at describing who I am by showing what I do, and by reflecting on the process. The information in the website, and the one on this blog, are meant to be grown like a plant, rather than to be thrown on a page with a date, and forgotten, and get stale, and stay partial, incomplete.</p>
<p>I have a couple of ideas to also improve the whole project, and they involve the transformation of the website into a wiki, to be kept together with the blog. Linearity and hyperlinks. More on this in later posts.</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../../competing-to-get-better/">Competing to get better</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2014-05-06
  </p>
  <p>I am always on the lookout for ways to enhance my proficiency with programming. In the last months I have come to agree with the common saying that, with programming languages, you only learn by doing.</p>
<!-- more -->

<p>One aspect of my training which I am focusing on at the moment is algorithm design. My training uses several resources that I wanted to briefly discuss, and I wanted to organize my thought about the way of my doing this.</p>
<h2>TopCoder</h2>
<p>One of the most popular places where programmers compete is surely TopCoder. Competitions involve solving 3 problems of increasing difficulty in 75 minutes. The computation of the final score is a complicated function of the time you spent to write a solution, and of the time taken by the other competitors. The participants are divided into 2 major divisions (division 1 being the harder one), and they are assigned to either according to their current ranking. Inside each division, people are further divided into rooms of 20 people (I might be imprecise on the numbers, but those are the orders of magnitude).</p>
<p>While this might not make you a better software developer, since it does not test your communication skills, and your ability to dive into large code bases and make meaningful and clear changes, it certainly helps to keep the mind sharp and to easily recognize an algorithmic problem when you see on. This is an especially handy skill for technical interviews at your favorite companies.</p>
<p>In the past months, I have started competing, and I am performing quite poorly, as you can see <a href="http://community.topcoder.com/tc?module=MemberProfile&amp;cr=22748950">here</a>; but I am getting better (even though the graph of my performance seems to confute my statement), and I am having a reality check of my ability as a problem solver.</p>
<h3>Similar websites</h3>
<p>There are two websites I want to try in the next days. <a href="http://codeforces.com/">CoderForces</a> provides a setting similar to TopCoder, while <a href="http://www.spoj.com/">SPOJ</a> seems to make without the time limit constraint.</p>
<h2>HackerRank and USACO</h2>
<p><a href="https://www.hackerrank.com/contests/w2">HackerRank</a> is a nice idea. It still contains contests, but the practice area is quite welcoming, and the problems are nicely divided into areas, that makes finding them a breeze. In TopCoder the problems are tagged, but not in the Arena (the Java applet used to connect to the servers for the competitions), so you might be forced to wade through the website to find them. I am currently participating to the <a href="https://www.hackerrank.com/contests/w2">Weekly Challenges - Week 2</a>, which consists in giving one problem per day, from Monday to Friday, from easiest to hardest. Its tough to juggle through the week and carve out the time to always be there, but that's part of the fun!</p>
<p>Also on HackerRank, I go by the nickname <a href="https://www.hackerrank.com/sturmer">sturmer</a>.</p>
<p>Somehow similarly to HackerRank, <a href="http://www.usaco.org/">USACO</a> provides, among its training resources, a guided path to practice to become a top competitor in the American Computing Olympiads. They may be aimed at high school students, but the consistency of the explanations and the guided advancement through the problems proves to be a great tool for honing one's skills in problem solving and gives a sense of accomplishment that might be lacking in more aggressive websites like TopCoder.</p>
<h2>Conclusions</h2>
<p>No code for this blog post. I have been spending a lot of time in competitive programming, and I feel that my algorithm design skills are constantly improving. I will probably discuss some of the interesting problems in the posts to come.</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../../unit-testing-with-google-test/">Unit Testing with Google Test</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2014-03-24
  </p>
  <p>In a previous <a href="../../unit-testing-with-cpptest/">post</a>, I have written a brief introduction to <em>CppTest</em>, and given some motivation as to why you should be using unit tests if you are not already. This week, I wanted to throw a glance at the competition, so I tried <a href="https://code.google.com/p/googletest/"><em>Google Test</em></a>. I still don't like macros, but these look actually useful.</p>
<!-- more -->

<h2>Tests by example</h2>
<p>As in the previous installment, I have considered the problem of finding a sequence of words that whould connect two words given in input, with the rule that to switch from one to the other we can change only one letter. The code is still buggy (sigh), and still lives on <a href="https://github.com/sturmer/MutatingWords">GitHub</a>.</p>
<p>The class defining the graph hasn't changed, but this time I have had to mention explicitly the names of the methods that are supposed to access the private section of <code>Graph</code></p>
<div class="hll"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">Graph</span> <span class="p">{</span>

  <span class="c1">// Private section here</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">friend</span> <span class="k">class</span> <span class="nc">GraphTestSuite</span><span class="p">;</span>
  <span class="n">FRIEND_TEST</span><span class="p">(</span><span class="n">GraphTestSuite</span><span class="p">,</span> <span class="n">TestAddNode</span><span class="p">);</span>
  <span class="n">FRIEND_TEST</span><span class="p">(</span><span class="n">GraphTestSuite</span><span class="p">,</span> <span class="n">TestDijkstra</span><span class="p">);</span>

  <span class="n">Graph</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">filename</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">AddNode</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">n</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">Dijkstra</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">start</span><span class="p">);</span>

  <span class="c1">// other public stuff</span>
<span class="p">};</span>
</pre></div>
<p>Google Test has a concept of test suite, which is a class that groups together logically related tests. You don't actually need to have a class with the name <code>GraphTestSuite</code>, unless you want to start writing code that is common to the tests in the suite, as it happened in CppTest.</p>
<p>In this case, we have declared that the tests <code>TestAddNode</code> and <code>TestDijkstra</code> will need access to the private members of <code>Graph</code>; we can write other tests in the same suite that don't need such access. One difference with respect to CppTest is that we don't have to register the tests: the magic macro <code>RUN_ALL_TESTS</code> will automatically find the tests to run, and run them.</p>
<p>In our example, we want to create a graph to be used in both the tests declared, so we actually declare a class like this:</p>
<div class="hll"><pre><span></span><span class="k">class</span> <span class="nc">GraphTestSuite</span> <span class="o">:</span> <span class="k">public</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Test</span> <span class="p">{</span>
<span class="k">protected</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">SetUp</span><span class="p">();</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">TearDown</span><span class="p">();</span>
  <span class="n">Graph</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;*</span> <span class="n">g</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
<p>Compare <code>SetUp</code> and <code>TearDown</code> with CppTest's <code>setup</code> and <code>tear_down</code>. As I said, no need to have a constructor only to add tests to the suite.</p>
<p>The test for the method <code>AddNode</code> is almost the same as the one we previously wrote for it using CppTest, with the difference of course of the name of the macros. Another noticeable difference comes from an interesting presentation on testing at Google (which apparently I'm not able to find again!), which convinced me of testing one thing per test. Compare with the multiple tests in one line, properly ANDed, of the post on CppTest. Here's the result:</p>
<div class="hll"><pre><span></span><span class="n">TEST_F</span><span class="p">(</span><span class="n">GraphTestSuite</span><span class="p">,</span> <span class="n">TestAddNode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;typo&quot;</span><span class="p">].</span><span class="n">size</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">EXPECT_STREQ</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;typo&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">&quot;type&quot;</span><span class="p">);</span>

  <span class="c1">// other tests</span>

  <span class="n">string</span> <span class="nf">s1</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">);</span>
  <span class="n">g</span><span class="o">-&gt;</span><span class="n">AddNode</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">size</span><span class="p">(),</span> <span class="mi">5</span><span class="p">);</span>
  <span class="n">EXPECT_TRUE</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span>
            <span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">end</span><span class="p">(),</span> <span class="n">s1</span><span class="p">)</span> <span class="o">!=</span>
          <span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">end</span><span class="p">());</span>
  <span class="c1">// other tests</span>
<span class="p">}</span>
</pre></div>
<h3><code>EXPECT</code> vs. <code>ASSERT</code></h3>
<p>In Google Test, we have to types of macros: <code>EXPECT</code> and <code>ASSERT</code>. After an <code>EXPECT</code> condition fails, the execution continues; after a failed <code>ASSERT</code>, it stops, because it would not make sense to continue. In this test, none of the single failures might be a serious error, and we have the advantage of being able to see more errors at a time, speeding up our development cycle.</p>
<p><code>EXPECT_TRUE</code> tests the general case when a condition has to be true for the test to pass. <code>EXPECT_EQ</code> is a shortcut for testing for equality, and is suggested over using <code>EXPECT_TRUE</code> whenever possible, because it will print more useful debugging information in case of failure (as you can read for example in the comments <a href="https://googletest.googlecode.com/svn/trunk/samples/sample1_unittest.cc">here</a>).</p>
<h2>Running the tests</h2>
<p>In the main function, we need to perform two operations:</p>
<ol>
<li>Initialize the library</li>
<li>call <code>RUN_ALL_TESTS</code></li>
</ol>
<p>like this:</p>
<div class="hll"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">InitGoogleTest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="n">RUN_ALL_TESTS</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p>Given this use of <code>EXPECT</code>, the previous tests (in their complete form, without the parts I have commented out to keep the code snippets clear) give the following output:</p>
<pre>
[==========] Running 3 tests from 2 test cases.
[----------] Global test environment set-up.
[----------] 1 test from UtilTestSuite
[ RUN      ] UtilTestSuite.TestGetHammingDistance
[       OK ] UtilTestSuite.TestGetHammingDistance (0 ms)
[----------] 1 test from UtilTestSuite (0 ms total)

[----------] 2 tests from GraphTestSuite
[ RUN      ] GraphTestSuite.TestAddNode
[       OK ] GraphTestSuite.TestAddNode (1 ms)
[ RUN      ] GraphTestSuite.TestDijkstra
[  FAILED  ] GraphTestSuite.TestDijkstra (2 ms)
[----------] 2 tests from GraphTestSuite (3 ms total)

[----------] Global test environment tear-down
[==========] 3 tests from 2 test cases ran. (4 ms total)
[  PASSED  ] 2 tests.
[  FAILED  ] 1 test, listed below:
[  FAILED  ] GraphTestSuite.TestDijkstra

1 FAILED TEST
</pre><p>Er, no, it still doesn't work. But I'm close!</p>
<blockquote><p>CAVEAT EMPTOR<br />
To use Google Test, link your code with both <code>gtest</code> and <code>pthread</code>.</p>
</blockquote>
<h3>Intermezzo: installing on Ubuntu</h3>
<p>I have installed the library on my Ubuntu box (13.10), which is kind of different from the usual <code>apt-get</code> procedure. You have to <code>apt-get</code> the package <code>libgtest-dev</code>; then, go to <code>/usr/src/gtest</code> and compile it by issuing the following commands (see also <a href="http://askubuntu.com/a/145913">this AskUbuntu answer</a>):</p>
<div class="hll"><pre><span></span>sudo cmake CMakeList.txt
sudo make
sudo cp *.a /usr/lib
</pre></div>
<p>The last command copies the resulting static libraries you have just compiled into the proper system location. <s>Wonder why they do things this way these days</s> The answer linked before seems to give a hint at why things are done this way.</p>
<h2>Death tests</h2>
<p>A death test is a test that checks whether a program terminates. This type of tests do not include termination by exception.</p>
<div class="hll"><pre><span></span><span class="kt">void</span> <span class="nf">ExitingFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;[MR3432] Too bad, we are exiting&quot;</span><span class="p">;</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">FirstDeathTest</span><span class="p">,</span> <span class="n">KillingAround</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">EXPECT_EXIT</span><span class="p">(</span><span class="n">ExitingFunction</span><span class="p">(),</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">ExitedWithCode</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
          <span class="s">&quot;[MR*] *&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">InitGoogleTest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="n">RUN_ALL_TESTS</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;I am still here :)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>The test above uses <code>EXPECT_EXIT</code>, which is one type of death test. The macro takes as arguments:</p>
<ol>
<li>a statement, in this case a call to the exiting function</li>
<li>a predicate, in this case a canned Google Test predicate that expects the function to just exit with code 0</li>
<li>a regular expression that should match what is printed by the function</li>
</ol>
<p>The result is the following:</p>
<pre>
[==========] Running 1 test from 1 test case.
[----------] Global test environment set-up.
[----------] 1 test from FirstDeathTest
[ RUN      ] FirstDeathTest.KillingAround
[       OK ] FirstDeathTest.KillingAround (5 ms)
[----------] 1 test from FirstDeathTest (5 ms total)

[----------] Global test environment tear-down
[==========] 1 test from 1 test case ran. (5 ms total)
[  PASSED  ] 1 test.
I am still here :)
</pre><h2>Summary</h2>
<p>In this post, I have reported on my early experiences with Google Test. I will keep on testing it, and I'll throw in also Google Mock, which is useful when we need to provide Mock classes in order to be able to test larger systems.</p>
<p>As a result, I have also subscribed to the <a href="../../unit-testing-with-google-test/googletesting.blogspot.com/">Google Testing blog</a>, hoping to reach the illumination on testing that might help me become a better engineer.</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../../unit-testing-with-cpptest/">Unit Testing with cpptest</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2014-03-17
  </p>
  <p>Unit testing is a fundamental activity in software development, even if not as widespread as it should. As C++ has been around for quite some time, several libraries are available for carrying out this activity. This week I've had a look at <em><a href="http://cpptest.sourceforge.net/">cpptest</a></em>. In the future, I plan to compare compare it to another pretty popular test library, <em><a href="https://code.google.com/p/googletest/">googletest</a></em>.</p>
<!-- more -->

<h2>The case in point</h2>
<p>I was playing with the Dijkstra algorithm this week, because I needed to write an algorithm to solve the following problem:</p>
<blockquote><p>Find whether there exists a sequence of words between two given words, such that the <a href="http://en.wikipedia.org/wiki/Hamming_distance">Hamming distance</a> between each word and the following is 1</p>
</blockquote>
<p>For example, I can go from <em>milk</em> to <em>typo</em> in 6 steps through the sequence:</p>
<blockquote><p>milk -&gt; mile -&gt; male -&gt; tale -&gt; tape -&gt; type -&gt; typo</p>
</blockquote>
<p>To do this, we can organize a dictionary into an undirected graph whose nodes are connected if and only if they have Hamming distance of 1.</p>
<h2>Unit tests</h2>
<p>In <em>cpptest</em>, we organize tests in <em>test suites</em>. A suite is declared as a class deriving publicly from <code>Test::Suite</code>. For example, I have a header file containing declarations of functions that are not related strictly to graphs. The header's name is <code>Util.hpp</code>, and the following is a snippet extracted from it:</p>
<div class="hll"><pre><span></span><span class="kt">int</span> <span class="nf">getHammingDistance</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">s1</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">s2</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">UtilTestSuite</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Test</span><span class="o">::</span><span class="n">Suite</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">UtilTestSuite</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">TEST_ADD</span><span class="p">(</span><span class="n">UtilTestSuite</span><span class="o">::</span><span class="n">test_get_hamming_distance</span><span class="p">);</span>
  <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">test_get_hamming_distance</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
<p>As you can see, there is the function, and then the test suite. Its constructor only <code>TEST_ADD</code>s methods for testing, in this case to test the function <code>getHammingDistance()</code>; the method itself is then declared in the private section of the class.</p>
<p>The implementation is pretty straightforward, and introduces another little concept: <em>Assertions</em>:</p>
<div class="hll"><pre><span></span><span class="kt">void</span> <span class="n">UtilTestSuite</span><span class="o">::</span><span class="n">test_get_hamming_distance</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">getHammingDistance</span><span class="p">(</span><span class="s">&quot;wind&quot;</span><span class="p">,</span> <span class="s">&quot;wand&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">getHammingDistance</span><span class="p">(</span><span class="s">&quot;wind&quot;</span><span class="p">,</span> <span class="s">&quot;wane&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">getHammingDistance</span><span class="p">(</span><span class="s">&quot;wind&quot;</span><span class="p">,</span> <span class="s">&quot;list&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">getHammingDistance</span><span class="p">(</span><span class="s">&quot;wind&quot;</span><span class="p">,</span> <span class="s">&quot;crow&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">getHammingDistance</span><span class="p">(</span><span class="s">&quot;wind&quot;</span><span class="p">,</span> <span class="s">&quot;winds&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">Infinity</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>Assertions work kind of like the function <code>assert</code> in the library header <code>&lt;cassert&gt;</code>: they check whether the condition is satisfied. The difference is that, in the case of <code>TEST_ASSERT</code>, the failed assertion does not stop the execution of the program, so to allow the collection of data about the execution of <em>all</em> the tests, instead of stopping at each error, giving the developer the chance to decide where to start concentrating his or her debugging efforts.</p>
<p>I have found that declaring the test suite in the header of the code we want to test is neat and useful for documentation.</p>
<h2>Running the tests</h2>
<p>In order to run the test, you instantiate a test suite and run it, possibly on an output handler. In my case, I have used a text output, that delivers the results of the tests to the console:</p>
<div class="hll"><pre><span></span><span class="n">Test</span><span class="o">::</span><span class="n">TextOutput</span> <span class="n">output</span><span class="p">(</span><span class="n">Test</span><span class="o">::</span><span class="n">TextOutput</span><span class="o">::</span><span class="n">Verbose</span><span class="p">);</span>
<span class="n">UtilTestSuite</span> <span class="n">uts</span><span class="p">;</span>
<span class="n">uts</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">output</span><span class="p">);</span>
</pre></div>
<p>When I run the program, I get the following results:</p>
<pre>
UtilTestSuite: 1/1, 100% correct in 0.000078 seconds
Total: 1 tests, 100% correct in 0.000078 seconds
</pre><p>Now imagine the sheer power you have at your fingertips: for any change you make at the function <code>getHammingDistance</code>, you just re-run the tests and you become confident about the quality of your changes. Of course, be sure to test your tests sometimes!</p>
<h2>Fixtures</h2>
<p>Sometimes we might want to have some data setup before running the tests, maybe because we want to use the same data for all of them, and initializing them might be expensive. In my case, I wanted to share a graph between two methods of the class <code>Graph</code>. The methods <code>setup()</code> and <code>tear_down()</code> are called by the CppTest library before and after all the tests are executed. Imagine the following:</p>
<div class="hll"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">Graph</span> <span class="p">{</span>
  <span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">adjlist</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">nodes</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">Graph</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">filename</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">AddNode</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">n</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">Dijkstra</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">start</span><span class="p">);</span>

  <span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">dist</span><span class="p">;</span>
  <span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">parent</span><span class="p">;</span>
  <span class="k">friend</span> <span class="k">class</span> <span class="nc">GraphTestSuite</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
<p>Of course you might want to rely on a well-reputed library and use the Boost Graph Library, that we have treated in <a href="../../exploring-the-boost-graph-library/">another post</a>. Here, I have done things manually, as part of my keeping fit for my job.</p>
<p>This graph class has a method for adding a node, and a method for computing the <a href="http://en.wikipedia.org/wiki/Dijkstra&#39;s_algorithm">Dijkstra algorithm</a> on it. We want to have access to the private data of the class in our test suite, so we declare it as a <code>friend</code> (we need to make a forward declaration of the suite itself before doing this).</p>
<p>Now we declare the Graph test suite:</p>
<div class="hll"><pre><span></span><span class="k">class</span> <span class="nc">GraphTestSuite</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Test</span><span class="o">::</span><span class="n">Suite</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">GraphTestSuite</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">TEST_ADD</span><span class="p">(</span><span class="n">GraphTestSuite</span><span class="o">::</span><span class="n">test_AddNode</span><span class="p">);</span>
    <span class="n">TEST_ADD</span><span class="p">(</span><span class="n">GraphTestSuite</span><span class="o">::</span><span class="n">test_Dijkstra</span><span class="p">);</span>
  <span class="p">}</span>

 <span class="k">protected</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">setup</span><span class="p">();</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">tear_down</span><span class="p">();</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">test_AddNode</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">test_Dijkstra</span><span class="p">();</span>
  <span class="n">Graph</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;*</span> <span class="n">g</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">GraphTestSuite</span><span class="o">::</span><span class="n">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Graph</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;t/test2.txt&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">GraphTestSuite</span><span class="o">::</span><span class="n">tear_down</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">delete</span> <span class="n">g</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Everything in the test suite class is as before, only we have a protected section declaring the fixture methods, and we have a private pointer to a <code>Graph</code> of <code>string</code>s, that is needed for the setup. In the <code>setup</code> method, we just create a <code>Graph</code> with <code>new</code> (this is generally bad, but I'll keep it simple here --- think <a href="http://en.wikipedia.org/wiki/Resource_Acquisition_Is_Initialization">RAII</a> for production code).</p>
<p>Now, I want to use that graph pointer to test both <code>AddNode</code> and <code>Dijkstra</code>:</p>
<div class="hll"><pre><span></span><span class="kt">void</span> <span class="n">GraphTestSuite</span><span class="o">::</span><span class="n">test_AddNode</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">string</span> <span class="nf">s1</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">);</span>  <span class="c1">// &quot;mile&quot; is in the dictionary</span>
  <span class="n">g</span><span class="o">-&gt;</span><span class="n">AddNode</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span>
                        <span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">end</span><span class="p">(),</span> <span class="n">s1</span><span class="p">)</span> <span class="o">!=</span>
              <span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">end</span><span class="p">());</span>
  <span class="n">string</span> <span class="nf">s2</span><span class="p">(</span><span class="s">&quot;five&quot;</span><span class="p">);</span>
  <span class="n">g</span><span class="o">-&gt;</span><span class="n">AddNode</span><span class="p">(</span><span class="n">s2</span><span class="p">);</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span>
                        <span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">end</span><span class="p">(),</span> <span class="n">s2</span><span class="p">)</span> <span class="o">==</span>
              <span class="n">g</span><span class="o">-&gt;</span><span class="n">adjlist</span><span class="p">[</span><span class="s">&quot;mile&quot;</span><span class="p">].</span><span class="n">end</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">GraphTestSuite</span><span class="o">::</span><span class="n">test_Dijkstra</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">g</span><span class="o">-&gt;</span><span class="n">Dijkstra</span><span class="p">(</span><span class="s">&quot;rice&quot;</span><span class="p">);</span>  <span class="c1">// rice is in the file</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">dist</span><span class="p">[</span><span class="s">&quot;typo&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">);</span>
  <span class="n">g</span><span class="o">-&gt;</span><span class="n">Dijkstra</span><span class="p">(</span><span class="s">&quot;typo&quot;</span><span class="p">);</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">dist</span><span class="p">[</span><span class="s">&quot;rice&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>As you see, both tests refer to a <code>g</code> variable, which is of course the member field of the <code>GraphTestSuite</code> class. The output, in my case, is:</p>
<pre>
UtilTestSuite: 1/1, 100% correct in 0.000018 seconds
Total: 1 tests, 100% correct in 0.000018 seconds
GraphTestSuite: 2/2, 50% correct in 0.002941 seconds
  Test:    test_Dijkstra
  Suite:   GraphTestSuite
  File:    ./graph.hpp
  Line:    113
  Message: g->dist\[\"rice\"\] == 7
</pre><p>Apparently, my implementation of Dijkstra is not symmetrical: it is possible to get to rice from typo, but apparently not the other way around. Sigh. But what's important here, is that we know which test has gone wrong, even thoug this doesn't prevent me from going bug-hunting in the next few hours.</p>
<h2>Summary</h2>
<p>I have explored the basic features of a nice library called <em>CppTest</em>. It is extremely pleasant to use, and provides a service that is of paramount importance in a software project, namely, unit testing. The library-related code is not invasive at all, and plays nicely with the application code. Tests can be organized and run together, and the results can be presented in different output formats (including HTML).</p>
<p>As you have seen, I have still some problems with my implementation of Dijkstra. The code is a <a href="https://github.com/sturmer/MutatingWords">micro project</a> on Github; if you spot the error and want to help me, I'll be glad to receive PRs.</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../../the-sqlite3-c-api/">The SQLite3 C++ API</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2014-03-10
  </p>
  <p>I was looking for some practice with DBs, and my choice fell on the <a href="http://www.sqlite.org">SQLite</a> project, maybe only because it looked lighter than PostgreSQL, which I also plan to play with. My first general impression about the API is that it looks a little too much C-oriented, even though I am not sure whether this is a good or a bad thing, and I am ignorant about the latitude of choice an engineer has when designing an API that has to interact with applications written in either C or C++.</p>
<!-- more -->

<p>In this post, I am going to dissect a basic utilization of the API, from setting up a ludicrously small database to running a query on the data.</p>
<h2>Creating the database</h2>
<p>Running <code>sqlite3</code> from the console, we are prompted by the SQLite interpreter. I have created a database of actors and movies, of which the following is the piece that I used to create the Movies table, plus an example insert statement:</p>
<div class="hll"><pre><span></span><span class="k">create</span> <span class="k">table</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">Movies</span><span class="p">(</span><span class="n">movieId</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">movieTitle</span><span class="p">,</span> <span class="n">movieYear</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">or</span> <span class="k">ignore</span> <span class="k">into</span> <span class="n">Movies</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;NIR97&#39;</span><span class="p">,</span> <span class="s1">&#39;Nirvana&#39;</span><span class="p">,</span>
  <span class="s1">&#39;1997&#39;</span><span class="p">);</span>
</pre></div>
<p>With this saved in a file <em>movies.sql</em>, from within the sqlite3 prompt you can run the command <code>.read movies.sql</code> to execute the statements of table creation and insertion of the data. I have saved then the DB with the command <code>.backup Gergelim.db</code>. At this point, I have started coding some C++.</p>
<h2>Querying</h2>
<p>The first thing we need in order to access a SQLite database is a handle, which is a pointer to an opaque structure called <code>sqlite3</code>. The way to do it is quite intuitive:</p>
<div class="hll"><pre><span></span><span class="n">sqlite3</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;open: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sqlite3_errstr</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>in which I assume to pass the name of the DB as the first and only parameter to the program. Most of the functions of the API return an integer that can be interpreted as an error code. The function <code>sqlite3_errstr(code)</code> provides a human-readable version of the error code.</p>
<p>Next, we must prepare the statement that we want to execute. The preparation is apparently a sort of "compilation" of the statement into something that is interpretable in later function calls (particularly the <code>sqlite3_step</code>, see below). There are currently two main versions of the prepare statement, and the docs encourage the use of version 2:</p>
<div class="hll"><pre><span></span><span class="n">string</span> <span class="n">zSql</span><span class="p">(</span>
  <span class="s">&quot;select movieTitle, movieYear from Movies where movieYear &gt; 2000;&quot;</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">zTail</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">**</span> <span class="n">pzTail</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zTail</span><span class="p">;</span>
<span class="n">sqlite3_stmt</span><span class="o">*</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="n">retval</span> <span class="o">=</span> <span class="n">sqlite3_prepare_v2</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">zSql</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="mi">-1</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">statement</span><span class="p">,</span>
  <span class="n">pzTail</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;prepare: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sqlite3_errstr</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>The syntax of the prepare statement feels a little awkward. It requires:</p>
<ol>
<li>a handle to the DB</li>
<li>the statement, as a <code>const char*</code></li>
<li>the maximum length of the abovementioned <code>const char*</code></li>
<li>a statement handle, as an output parameter</li>
<li>an output pointer to the unused portion of <code>zSql</code></li>
</ol>
<p>There are a couple of concepts here that need explaining. The following is the declaration of the <code>sqlite3_prepare_v2</code> function from the <a href="http://www.sqlite.org/c3ref/prepare.html">SQLite API documentation</a>:</p>
<div class="hll"><pre><span></span><span class="kt">int</span> <span class="nf">sqlite3_prepare_v2</span><span class="p">(</span>
  <span class="n">sqlite3</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span>            <span class="cm">/* Database handle */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zSql</span><span class="p">,</span>       <span class="cm">/* SQL statement, UTF-8 encoded */</span>
  <span class="kt">int</span> <span class="n">nByte</span><span class="p">,</span>              <span class="cm">/* Maximum length of zSql in bytes. */</span>
  <span class="n">sqlite3_stmt</span> <span class="o">**</span><span class="n">ppStmt</span><span class="p">,</span>  <span class="cm">/* OUT: Statement handle */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">pzTail</span>     <span class="cm">/* OUT: Pointer to unused portion of zSql */</span>
<span class="p">);</span>
</pre></div>
<p>The parameter <code>nByte</code>, if set to a negative number, has the API implementation read <code>zSql</code> until the zero terminator; otherwise, if we had, say, a text file with many statements, we could pass the length of the statement to interpret, starting from what is pointed by <code>zSql</code>. If <code>pzTail</code> is not null, then it is filled with the pointer to the position of the zSql string that has not been interpreted: only one SQL statement at a time is interpreted by this function.</p>
<p>After we have prepared the statement, we can execute it. This is done via calling <code>sqlite3_step()</code>. This function returns a row of the query, if successful; otherwise, it may return either the code <code>SQLITE_DONE</code>, to indicate that the set of rows has finished; or another type of error. This means that to read the result set, we need to call <code>sqlite3_step()</code> until we get a <code>SQLITE_DONE</code>, or we get an error. Reading the result set can be done this way:</p>
<div class="hll"><pre><span></span><span class="k">const</span> <span class="kt">int</span> <span class="n">num_columns</span> <span class="o">=</span> <span class="n">sqlite3_column_count</span><span class="p">(</span><span class="n">statement</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">sqlite3_step</span><span class="p">(</span><span class="n">statement</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">SQLITE_ROW</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// There is another row after this one: read this row</span>
        <span class="c1">// for now</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_columns</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">row_element</span> <span class="o">=</span>
              <span class="n">sqlite3_column_text</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
            <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">row_element</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">SQLITE_DONE</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// no more rows: exit</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;step: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sqlite3_errstr</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">statements</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h2>Keeping the house clean</h2>
<p>Some of the mentioned API calls allocate memory, that has to be freed when the execution aborts for some error (e.g., an empty result set). In particular, we have to free the memory for each statement we have prepared with <code>sqlite3_prepare_v2()</code>, by calling <code>sqlite3_finalize()</code>; and we have to close the connection to the DB, with a <code>sqlite3_close()</code>. Since we might need to free the resources in more than one place, I thought it would be a good idea to group the statements in a function:</p>
<div class="hll"><pre><span></span><span class="kt">int</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">sqlite3</span><span class="o">*</span> <span class="n">handle</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">sqlite3_stmt</span><span class="o">*&gt;</span> <span class="n">statements</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
    <span class="c1">// Destroy statements</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">s</span> <span class="p">:</span> <span class="n">statements</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">sqlite3_finalize</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;finalize: &quot;</span> <span class="o">&lt;&lt;</span>
              <span class="n">sqlite3_errstr</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;finalize: OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Close connection</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;close: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sqlite3_errstr</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;close: OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<h2>Memory management considerations</h2>
<p>With all the talking about RAII and being able to be in control exactly of the life cycle of objects and resources in general, it feels a bit scary to manage memory in this way; but I am sure there is some better way of doing this with the C++11 smart pointers. For example, we could enclose the pointer to the prepared statement returned by <code>sqlite3_prepare_v2()</code> in a smart pointer, if we could provide the <code>sqlite3_finalize()</code> function as callback to be used when destroying the memory allocated. The same can be said of <code>sqlite3_open()</code>/<code>sqlite3_close()</code>.</p>
<p>I haven't found a way to use smart pointers to achieve this. I will keep looking, and I'd be glad if anyone could point me to a solution.</p>
<h2>Summary</h2>
<p>I have created a minimal SQLite3 database, and executed a query on it using the C/C++ API documented on <a href="http://www.sqlite.org/c3ref/intro.html">sqlite.org</a>. As I have said, things feel a little too C, but I might be using it naively. If I discover anything that can be done nicer, I'll get back to this post and update it, as usual.</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../../hash-tables/">Hash Tables</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2014-03-03
  </p>
  <p>Before C++11, hash tables could be used in C++ only with some tricks. The only associative container available in the STL used to be the <code>std::map</code> (along with its sibling, the <code>multimap</code>). This class, however, is implemented as a binary search tree, and does not provide a way to customize a hash function. What hurt me most was that you didn't have the great performances offered by a true hash map: almost constant time insert, delete, and search (depending on how good is the hash function). You insert in O(log N) time. You find in O(log N) time. Too bad.</p>
<!-- more -->

<p>Truth is, hash tables were available through some <code>tr1</code> extension, which I have not had the chance to use ever in my short career. It is thus with exultance that I saluted the introduction of hash tables with the more recent standard.</p>
<p>In this post, I want to group the common usage of this data structure, and in the process I want to keep in one place the list of operations I use the most.</p>
<h2><code>unordered_map</code>?!</h2>
<p>I understand historical reasons (sometimes), but can you find a less appropriate name for a hash table? Since C++11, the engineer uses a hash table by including a header called <code>unordered_map</code>, because the hash table's name in C++ is <code>unordered_map</code>. (There are other containers based on hash functions, but they follow a similar logic.)</p>
<p>An <code>unordered_map</code> is declared as follows ([unord.map.syn]):</p>
<div class="hll"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">T</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">Hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">Pred</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">equal_to</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">Allocator</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Key</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;&gt;&gt;</span>
<span class="k">class</span> <span class="nc">unordered_map</span><span class="p">;</span>
</pre></div>
<p>What you always need to declare is the first two types, namely, the type of the key (the unique identifier you use to access the hashed data), and the type of the data; the other template types are optional, and usually I go with the default, unless I need some particular behavior. For example, <code>hash</code> is a standard function available in <code>&lt;functional&gt;</code>, already implemented for all the integral types and for some special types (<a href="http://www.cppstdlib.com/">Josuttis</a>), and it is designed so as to satisfy the requirements described in the standard ([unord.hash]).</p>
<p>A practical usage in a declaration would be something like:</p>
<div class="hll"><pre><span></span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">ages</span><span class="p">;</span>
</pre></div>
<p>This object would be used to map strings to <code>int</code> values, for instance in an association Name-Age. The representation of this container is a collection of <code>std::pair</code> objects, accessible in O(1) time by applying the hash function to the <code>Key</code>. Pairs corresponding to the same hash value, though rare, are grouped in linked lists.</p>
<p>This map has the usual caveat as the <code>std::map</code>, that is, accessing an
element with <code>operator[]</code> would create the entry if it did not exist already, using the default type constructor of the type <code>T</code> if nothing else is provided --- in this case, the int would simply be initialized with 0. The snippet:</p>
<div class="hll"><pre><span></span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">ages</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ages</span><span class="p">[</span><span class="s">&quot;Clint&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">41</span><span class="p">)</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Clint has 41 years</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">ages</span><span class="p">)</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</pre></div>
<p>would inadvertently produce the output</p>
<pre>
Clint: 0
</pre><p>because the test would create a pair Clint, 0; then would fail because 0 is not 41, and finally it would candidly produce the unexpected result shown. When I need to access an element, I use the <code>find</code> method to check if it is there already, and then do the work:</p>
<div class="hll"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">ages</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;Clint&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ages</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ages</span><span class="p">[</span><span class="s">&quot;Clint&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">41</span><span class="p">)</span>
    <span class="p">...</span>
</pre></div>
<h2>The interface</h2>
<p>The most common operations I perform on a has table are insertion and retrieval; less often, I remove elements.</p>
<h3>Insert</h3>
<p>There are more ways to insert elements; what I find the cleanest is:</p>
<div class="hll"><pre><span></span><span class="n">ages</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="s">&quot;Clint&quot;</span><span class="p">,</span> <span class="mi">83</span><span class="p">})</span>
</pre></div>
<p>This uses the uniform initialization syntax and the fact that an element of the map is actually a <code>std::pair</code>. As seen before, we could use the <code>operator[]</code> to perform the same operation:</p>
<div class="hll"><pre><span></span><span class="n">ages</span><span class="p">[</span><span class="s">&quot;Clint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">83</span><span class="p">;</span>
</pre></div>
<p>This is actually closer to what happens in other languages, like JavaScript.</p>
<h3>Access</h3>
<p>To actually look for an element, you can use the <code>find()</code> method, as shown above, which returns an iterator. An alternative would be to use the method <code>at()</code>. The problem with the latter is that it throws an exception when the element is not in the map. Since, as a rule in my life, I do not use exceptions if not for exceptional situations, I prefer to use this only if I actually <em>expect</em> the element to be there, and to be then surprised by its absence; which I would not, because I'd surround the statement containing the access by <code>at()</code> with a try-catch block. The exception thrown is the <code>out_of_range</code>.</p>
<div class="hll"><pre><span></span><span class="k">try</span> <span class="p">{</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">ages</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;Clint&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No such element: Clint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<h3>Remove</h3>
<p>Removing elements from a hash table can be done with the <code>erase()</code> and the <code>clear()</code> methods. The first is supposed to remove the elements by value, by position, or by range. The first snippet removes the element whose <code>Key</code> is <em>Terence</em>:</p>
<div class="hll"><pre><span></span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">ages</span><span class="p">;</span>
<span class="n">ages</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="s">&quot;Clint&quot;</span><span class="p">,</span> <span class="mi">83</span><span class="p">});</span>
<span class="n">ages</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="s">&quot;Terence&quot;</span><span class="p">,</span> <span class="mi">74</span><span class="p">});</span>
<span class="n">ages</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="s">&quot;Kevin&quot;</span><span class="p">,</span> <span class="mi">59</span><span class="p">});</span>

<span class="c1">// Remove by value</span>
<span class="n">ages</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="s">&quot;Terence&quot;</span><span class="p">);</span>
</pre></div>
<p>Using the position would require us to provide an iterator. This is something I rarely do, unless after a <code>find()</code>:</p>
<div class="hll"><pre><span></span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">ages</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;Kevin&quot;</span><span class="p">);</span>
<span class="n">ages</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</pre></div>
<p>Finally, providing a range is something I have not done yet; it makes more sense if you are using an <code>unordered_multimap</code>, because in that case you can have more values corresponding to the same key, and the <code>find()</code> actually returns a pair of iterators defining a range.</p>
<p>One nice thing about <code>erase()</code> is that it is required never to invalidate iterators in the container.</p>
<h2>The fine details</h2>
<p>The implementation of the STL hash table involves some design decisions. Some of them are mandated by the standard; others are delegated to the library implementers.</p>
<p>An implementation stores the <em>(key, element)</em> pairs in so-called <em>buckets</em>. The destination bucket is determined by the hashed value of the key. So if we have 10 buckets, and hash("Clint") is 7, then the pair ("Clint", 83) goes in the seventh bucket (or the eight, if you start counting from 0). The number of buckets in the table has a direct influence on the probability of hash collisions, that occur when two keys hash to the same position. The <em>load factor</em> is the ratio between number of elements and number of buckets. Higher load factors imply higher probabilities of having collisions: it would be like having a house with a parking lot for 2 cars and throwing parties with tens of invitees.</p>
<p>The programmer can control part of the behavior of the hash table. We can set the max load factor, which is the number of elements that the container tolerates without triggering an automatic rehash; and we can manually rehash the table.</p>
<p><em>Rehashing</em> means <em>changing the number of buckets</em> in the has table. It is controllable through the methods <code>rehash()</code>, which takes the desired minimum size of each bucket; and by the method <code>reserve()</code>, which is more intuitive because you feed it the number of buckets directly. You have no control, however, on how many buckets are added or removed when rehashing (the <em>growth factor</em>).</p>
<div class="hll"><pre><span></span><span class="n">ages</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</pre></div>
<p><em>Automatic rehashing</em> is performed by the container when the load factor exceeds a set value. You can't control how few elements have to be in the container to trigger an automatic rehash (that can be imagined as the <em>minimum load factor</em>).</p>
<h3>Caveat on <code>Key</code> and <code>T</code></h3>
<p>There are some restrictions of which we must be aware when we complicate things and use <code>Key</code> and/or <code>T</code> types which are not primitive or provided by libraries.</p>
<ol>
<li><code>Key</code> must be a moveable and copyable type; it also has to be <code>const</code>, because it is used to access the position of the element.</li>
<li><code>T</code> must be comparable with equal</li>
</ol>
<h2>Summary</h2>
<p>At Yahoo!, someone (I honestly can't remember who, but I've read this in one of Gayle Laakmann McDowell's books) once said: the three most used data structures in our code are, in order, hash tables, hash tables, and hash tables. They have numerous applications, and using them effectively (well, using them at all) can make the difference between a good solution and a bad idea.</p>
<p>In this post, I have described a somehow distilled workflow to use this powerful data structure with the <code>unordered_map</code> provided by the STL.</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../../accessing-apis/">Accessing APIs</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2014-03-02
  </p>
  <p>I was curious about all the great sites I know of releasing their API. Twitter, Google, Facebook, Yelp, are only a few examples of websites providing a way to access their services in a programmatic way. In this post, I have investigated a simple but very interesting API, offered by <a href="http://rottentomatoes.com" title="Rotten Tomatoes">Rotten Tomatoes</a>, a website about movies.</p>
<!-- more -->

<h3>Before Coding</h3>
<p>Apparently, most if not all the websites offering API access to their services, require you to register as a developer, in order to provide you with an API key. The registration form for Rotten Tomatoes can be found, for example, at the <a href="http://bit.ly/1eoIiOB" title="Rotten Tomatoes API">Developers' page</a>.  Once you register an account and request an API key, you can use it to access the API. This kind of accountability is important, because the damage you can do by making tons of requests to a website can easily become an example of DoS attacks. The number of requests is limited, as well (5 per seconds and 10,000 per day).</p>
<h3>The POCO Libraries</h3>
<p>In order to more easily manipulate HTTP requests and response, I have tried out the <a href="http://pocoproject.org/" title="POCO libraries">POCO libraries</a>, a nice set of wrappers around extremely useful features, that range from Base64 encoding/decoding to socket programming, to XML manipulation, to DBMS interactions. The simple code I provide here uses the <em>Net</em> classes, that offer useful abstractions like <code>HTTPRequest</code>, <code>HTTPResponse</code>, <code>HTMLForm</code>, and the likes.</p>
<div class="hll"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">HTTPRequest</span> <span class="n">movierequest</span><span class="p">(</span><span class="n">HTTPRequest</span><span class="o">::</span><span class="n">HTTP_GET</span><span class="p">,</span>
            <span class="s">&quot;/api/public/v1.0/movies.json&quot;</span><span class="p">,</span>
            <span class="n">HTTPMessage</span><span class="o">::</span><span class="n">HTTP_1_1</span><span class="p">);</span>
        <span class="n">HTMLForm</span> <span class="n">form</span><span class="p">;</span>
        <span class="n">form</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;apikey&quot;</span><span class="p">,</span> <span class="s">&quot;{your_api_key}&quot;</span><span class="p">);</span> <span class="c1">// use your API key here!!</span>
        <span class="n">form</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;page&quot;</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
        <span class="n">form</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;page_limit&quot;</span><span class="p">,</span> <span class="s">&quot;10&quot;</span><span class="p">);</span>
        <span class="n">form</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;q&quot;</span><span class="p">,</span> <span class="s">&quot;Toy+Story&quot;</span><span class="p">);</span>
        <span class="n">form</span><span class="p">.</span><span class="n">prepareSubmit</span><span class="p">(</span><span class="n">movierequest</span><span class="p">);</span>

        <span class="n">HTTPClientSession</span> <span class="n">s</span><span class="p">(</span><span class="s">&quot;api.rottentomatoes.com&quot;</span><span class="p">);</span>
        <span class="n">s</span><span class="p">.</span><span class="n">sendRequest</span><span class="p">(</span><span class="n">movierequest</span><span class="p">);</span>
        <span class="n">HTTPResponse</span> <span class="n">resp</span><span class="p">;</span>
        <span class="n">istream</span><span class="o">&amp;</span> <span class="n">response_stream</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">receiveResponse</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">resp</span><span class="p">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">resp</span><span class="p">.</span><span class="n">getReason</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="n">ofstream</span> <span class="n">result</span><span class="p">(</span><span class="s">&quot;toystory.txt&quot;</span><span class="p">);</span>
        <span class="n">Poco</span><span class="o">::</span><span class="n">StreamCopier</span><span class="o">::</span><span class="n">copyStream</span><span class="p">(</span><span class="n">response_stream</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Poco</span><span class="o">::</span><span class="n">Exception</span><span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Exception: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ex</span><span class="p">.</span><span class="n">className</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; -- &quot;</span> <span class="o">&lt;&lt;</span>
            <span class="n">ex</span><span class="p">.</span><span class="n">displayText</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Let's examine this code from closer. The complete source code is provided as a <a href="https://gist.github.com/sturmer/8755127">Github gist</a>.</p>
<h3>Making a GET request</h3>
<p>Let's dissect the code presented above.</p>
<div class="hll"><pre><span></span><span class="n">HTTPRequest</span> <span class="nf">movierequest</span><span class="p">(</span><span class="n">HTTPRequest</span><span class="o">::</span><span class="n">HTTP_GET</span><span class="p">,</span>
    <span class="s">&quot;/api/public/v1.0/movies.json&quot;</span><span class="p">,</span>
    <span class="n">HTTPMessage</span><span class="o">::</span><span class="n">HTTP_1_1</span><span class="p">);</span>
</pre></div>
<p>We make an <code>HTTP GET</code> request in order to retrieve data from the web service by passing the proper parameters in a query string. The POCO libraries give us access to an <code>HTTPRequest</code>, that is constructed by passing it the HTTP method, the last part of the query url, and the version of HTTP, for which two enum values are provided, <code>HTTP_1_0</code> and <code>HTTP_1_1</code>, for versions 1.0 and 1.1.</p>
<div class="hll"><pre><span></span><span class="n">HTMLForm</span> <span class="n">form</span><span class="p">;</span>
<span class="n">form</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;apikey&quot;</span><span class="p">,</span> <span class="s">&quot;{your_api_key}&quot;</span><span class="p">);</span>
<span class="n">form</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;page&quot;</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
<span class="n">form</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;page_limit&quot;</span><span class="p">,</span> <span class="s">&quot;10&quot;</span><span class="p">);</span>
<span class="n">form</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;q&quot;</span><span class="p">,</span> <span class="s">&quot;Toy+Story&quot;</span><span class="p">);</span>
<span class="n">form</span><span class="p">.</span><span class="n">prepareSubmit</span><span class="p">(</span><span class="n">movierequest</span><span class="p">);</span>
</pre></div>
<p>The <code>HTMLForm</code> is useful for passing parameters to the request. This
is just done by providing key-value pairs for each relevant parameter. As you
see, when we are done, we call a <code>prepareSubmit()</code> method to pass
the values to the request object.</p>
<h3>Calling the Server, Reading the Response</h3>
<p>In order to call the API service, we need to instantiate a <code>HTTPClientSession</code> object, that is initialized with the name of the host providing the service.</p>
<div class="hll"><pre><span></span><span class="n">HTTPClientSession</span> <span class="nf">s</span><span class="p">(</span><span class="s">&quot;api.rottentomatoes.com&quot;</span><span class="p">);</span>
<span class="n">s</span><span class="p">.</span><span class="n">sendRequest</span><span class="p">(</span><span class="n">movierequest</span><span class="p">);</span>
</pre></div>
<p>The request is sent by calling the method <code>sendRequest()</code>. It is interesting that, in case we wanted to pass a body (for example in a POST request), we could have simply called the get <code>operator&lt;&lt;()</code>, like <code>s.sendRequest() &lt;&lt; req_body;</code>.</p>
<div class="hll"><pre><span></span><span class="n">HTTPResponse</span> <span class="n">resp</span><span class="p">;</span>
<span class="n">istream</span><span class="o">&amp;</span> <span class="n">response_stream</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">receiveResponse</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">resp</span><span class="p">.</span><span class="n">getStatus</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">resp</span><span class="p">.</span><span class="n">getReason</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="n">ofstream</span> <span class="nf">result</span><span class="p">(</span><span class="s">&quot;toystory.txt&quot;</span><span class="p">);</span>
<span class="n">Poco</span><span class="o">::</span><span class="n">StreamCopier</span><span class="o">::</span><span class="n">copyStream</span><span class="p">(</span><span class="n">response_stream</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</pre></div>
<p>Finally, we want to get the response. We instantiate an object of type <code>HTTPResponse</code>, not surprisingly, and then call the <code>receiveResponse()</code> on the client-initiated session object. The <code>StreamCopier</code> is useful to print the result into an output stream, that we can then parse at will.</p>
<p>The resulting file looks something like the following:</p>
<div class="hll"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;total&quot;</span> <span class="o">:</span> <span class="mf">3</span><span class="p">,</span>
    <span class="s2">&quot;movies&quot;</span> <span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;770672122&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Toy Story 3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;year&quot;</span> <span class="o">:</span> <span class="mf">2010</span><span class="p">,</span>
        <span class="s2">&quot;mpaa_rating&quot;</span> <span class="o">:</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span>
        <span class="s2">&quot;runtime&quot;</span> <span class="o">:</span> <span class="mf">103</span><span class="p">,</span>
        <span class="s2">&quot;critics_consensus&quot;</span> <span class="o">:</span> <span class="s2">&quot;Deftly blending comedy, adventure, and honest emotion...&quot;</span><span class="p">,</span>
        <span class="s2">&quot;release_dates&quot;</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;theater&quot;</span> <span class="o">:</span> <span class="s2">&quot;2010-06-18&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dvd&quot;</span> <span class="o">:</span> <span class="s2">&quot;2010-11-02&quot;</span><span class="p">},</span>
        <span class="s2">&quot;ratings&quot;</span> <span class="o">:</span> <span class="p">...</span>
</pre></div>
<h3>Conclusions</h3>
<p>The POCO libraries have been an interesting surprise. They are very well documented, and simplify several tasks which prove fundamental when dealing with the network.</p>
<p>I have tried also to access the Twitter API, but that deserves a post apart, because I had some problems with the authentication that is more sophisticated than Rotten Tomatoes', also because of the huge amount of data that you can query. A great tool for debugging your programs can be found at the <a href="http://developer.rottentomatoes.com/io-docs">IO Docs page</a>, that generates the request string according to the parameter provided in a form, executes the request, and finally displays the result; a similar tool is present also for Twitter.</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../../iterators-and-algorithms-insert-iterator-adapters/">Iterators and Algorithms: Insert Iterator Adapters</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2014-02-17
  </p>
  <p>This week I have had a look at two nice types of iterators: the <em>move iterators</em> and the <em>insert iterators</em>. Their main use seems to be related to STL algorithms.</p>
<!-- more -->

<h2>Problem: Copy a <code>std::vector</code> into another</h2>
<p>Let's suppose that we have a vector of the usual <code>int</code> type, that we fill diligently with an initializer list. After a few lines of code, we want to copy its elements into another vector. Our vanilla try will be:</p>
<div class="hll"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v1</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">});</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v2</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
</pre></div>
<p>This is OK, because the constructor of <code>v2</code> is invoked in order to copy every element of v1. Let's complicate matters, and say we only want the odd elements of <code>v1</code> to be used to initialize <code>v2</code>. We have a look at our reference card for STL algorithms (when will I prepare one?), and notice the presence of the <code>copy_if</code> algorithm, which works like this (extracted from my GNU standard library headers):</p>
<div class="hll"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_InputIterator</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">_OutputIterator</span><span class="p">,</span>
   <span class="k">typename</span> <span class="nc">_Predicate</span><span class="o">&gt;</span>
<span class="n">_OutputIterator</span>
<span class="n">copy_if</span><span class="p">(</span><span class="n">_InputIterator</span> <span class="n">__first</span><span class="p">,</span> <span class="n">_InputIterator</span> <span class="n">__last</span><span class="p">,</span>
    <span class="n">_OutputIterator</span> <span class="n">__result</span><span class="p">,</span> <span class="n">_Predicate</span> <span class="n">__pred</span><span class="p">)</span>
</pre></div>
<p>It takes an input range (<code>__first</code>, <code>__last</code>), and an iterator to the beginning of the result container, plus a predicate to select the elements. One innocent way of using it would be:</p>
<div class="hll"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v1</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">});</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v2</span><span class="p">;</span>
<span class="n">copy_if</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">v1</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">v1</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
        <span class="p">[](</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">n</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">});</span>
</pre></div>
<p>Which is cute, actually. Only problem is, that if now you try to run your program, it will segfault without a blink. And why is that? Simply because the iterator returned by <code>v2.begin()</code> behaves like a null pointer:</p>
<div class="hll"><pre><span></span><span class="o">(</span>gdb<span class="o">)</span> p v2
<span class="nv">$2</span> <span class="o">=</span> <span class="o">{</span>&lt;std::_Vector_base&lt;int, std::allocator&lt;int&gt; &gt;&gt; <span class="o">=</span> <span class="o">{</span>
    <span class="nv">_M_impl</span> <span class="o">=</span> <span class="o">{</span>&lt;std::allocator&lt;int&gt;&gt; <span class="o">=</span> <span class="o">{</span>&lt;__gnu_cxx::new_allocator&lt;int&gt;&gt; <span class="o">=</span> <span class="o">{</span>&lt;No data fields&gt;<span class="o">}</span>, &lt;No data fields&gt;<span class="o">}</span>, <span class="nv">_M_start</span> <span class="o">=</span> 0x0, <span class="nv">_M_finish</span> <span class="o">=</span> 0x0,
      <span class="nv">_M_end_of_storage</span> <span class="o">=</span> 0x0<span class="o">}}</span>, &lt;No data fields&gt;<span class="o">}</span>
<span class="o">(</span>gdb<span class="o">)</span> p v2.begin<span class="o">()</span>
<span class="nv">$3</span> <span class="o">=</span> <span class="o">{</span><span class="nv">_M_current</span> <span class="o">=</span> 0x0<span class="o">}</span>
</pre></div>
<p>This you can check by running a test like</p>
<div class="hll"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">v2</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">==</span> <span class="n">v2</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Problem: v2 is empty</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p>or equivalently, checking for <code>v2</code>'s <code>size()</code>.</p>
<h2>Insert iterator adapters</h2>
<p>This is where the insert iterator comes in handy. The problem is that the <code>copy_if</code> algorithm is not supposed to insert new elements in an empty container. What we need is an <em>insert iterator adapter</em>. They come in three flavors:</p>
<div class="hll"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_Container</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">insert_iterator</span>
<span class="o">:</span> <span class="k">public</span> <span class="n">iterator</span><span class="o">&lt;</span><span class="n">output_iterator_tag</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="o">&gt;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_Container</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">back_insert_iterator</span>
<span class="o">:</span> <span class="k">public</span> <span class="n">iterator</span><span class="o">&lt;</span><span class="n">output_iterator_tag</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="o">&gt;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_Container</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">front_insert_iterator</span>
<span class="o">:</span> <span class="k">public</span> <span class="n">iterator</span><span class="o">&lt;</span><span class="n">output_iterator_tag</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="o">&gt;</span>
</pre></div>
<p>As you see, all of them are derived from the standard iterator with traits of an <code>output_iterator_tag</code>. I find it useful to show the hierarchy of iterators, described also in Stroustrup:</p>
<blockquote><p>Input/Output &lt;- Forward &lt;- Bidirectional &lt;- Random access</p>
</blockquote>
<p>This means that the adapters provide the basic operator features, dereference with assignment (<code>*p=</code>) and increment by one (<code>++p</code>).</p>
<p>Their use can be summarized as follows:</p>
<blockquote><p>An insert iterator adapter, defined on a container, calls the
appropriate insertion method on the container when it is assigned.</p>
</blockquote>
<h3>The <code>back_insert_iterator</code></h3>
<p>Look at the definition of the <code>back_insert_iterator</code>'s <code>operator=()</code> in my system's STL implementation:</p>
<div class="hll"><pre><span></span><span class="n">back_insert_iterator</span><span class="o">&amp;</span>
<span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="k">typename</span> <span class="nc">_Container</span><span class="o">::</span><span class="n">value_type</span><span class="o">&amp;</span> <span class="n">__value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">container</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">__value</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">back_insert_iterator</span><span class="o">&amp;</span>
<span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">typename</span> <span class="nc">_Container</span><span class="o">::</span><span class="n">value_type</span><span class="o">&amp;&amp;</span> <span class="n">__value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">container</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">__value</span><span class="p">));</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>This means that we can have code that does the following:</p>
<div class="hll"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v1</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">});</span>
<span class="n">back_insert_iterator</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">b</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
</pre></div>
<p>We have just added an element to <code>v1</code>. Now let's get back at our original example:</p>
<div class="hll"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v1</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">});</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v2</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * The right way.</span>
<span class="cm"> */</span>
<span class="n">back_insert_iterator</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">inserter</span><span class="p">(</span><span class="n">v2</span><span class="p">);</span>
<span class="n">copy_if</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">v1</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">inserter</span><span class="p">,</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">n</span><span class="p">){</span><span class="k">return</span> <span class="n">n</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">});</span>

<span class="cm">/*</span>
<span class="cm"> * Variation. Use a back_inserter.</span>
<span class="cm"> */</span>
<span class="n">copy_if</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">v1</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">back_inserter</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">n</span><span class="p">){</span><span class="k">return</span> <span class="n">n</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">});</span>
</pre></div>
<p>As you can see on line 12 of the snippet above, we can also use an function called <code>back_inserter</code>, which returns a <code>back_insert_iterator</code> defined on the type of the argument passed.</p>
<h2>Summary</h2>
<p>In this post, I have written about my experiments with insert iterator adapters, which are useful classes offered by the STL that can be used to provide an insertion interface for STL containers. I have started with the problem of using STL algorithms with containers, and shown how to solve it using these standard C++ classes.</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../../stl-algorithms-part-5/">STL Algorithms, part 5</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2014-02-04
  </p>
  <ul>
<li><a href="../../stl-algorithms-part-1/">Part 1</a></li>
<li><a href="../../stl-algorithms-part-2/">Part 2</a></li>
<li><a href="../../stl-algorithms-part-3/">Part 3</a></li>
<li><a href="../../stl-algorithms-part-4/">Part 4</a></li>
<li><a href="../../stl-algorithms-part-5/">Part 5</a></li>
</ul>
<p>In the <a href="../../2014/01/14/stl-algorithms-part-4">previous post</a> in the series, we have analyzed more algorithms from the STL considered to be part of the non-modifying sequence operations. In this post, we are going to show some use case for algorithms which fall into the modifying sequence operations.</p>
<!-- more -->

<p>As brilliantly pointed out in <a href="http://www.cppstdlib.com/">Josuttis</a>, however, note that an unordered container and an associative container can never be used as the destination of a modifying algorithm. The rationale is that elements in that kind of containers are constant after they've been inserted, and changing their content might compromise their order established by the sorting and hashing functions.</p>
<h2><code>copy</code> and <code>move</code></h2>
<p>We have seen an example in the <a href="../../2014/02/17/iterators-and-algorithms">last post</a>, where we have shown how to combine the <code>copy</code> algorithm with a <code>back_inserter</code> to provide, among other goodies, an elegant way of printing containers. The <code>copy</code> algorithm performs a sequence of assignments from elements of a container to elements of another one.  Its declaration, as defined in the standard ([alg.copy]), is:</p>
<div class="hll"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">InputIterator</span><span class="p">,</span> <span class="k">class</span> <span class="nc">OutputIterator</span><span class="o">&gt;</span>
<span class="n">OutputIterator</span> <span class="n">copy</span><span class="p">(</span><span class="n">InputIterator</span> <span class="n">first</span><span class="p">,</span>
                    <span class="n">InputIterator</span> <span class="n">last</span><span class="p">,</span>
                    <span class="n">OutputIterator</span> <span class="n">result</span><span class="p">);</span>
</pre></div>
<p>It's really easy to understand with an example:</p>
<div class="hll"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">});</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">primes</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">});</span>

<span class="n">copy</span><span class="p">(</span><span class="n">primes</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">primes</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">v</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

<span class="c1">// Using Louis Delacroix&#39;s cxx-prettyprint</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;v: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</pre></div>
<p>This copies the elements from the fifth to the last of the vector <code>primes</code> into the vector v, starting from the third position. Be very careful here: we are not inserting those elements between the elements 2 and the 3 of the vector <code>v</code>, we are overwriting positions 2 to 4 (starting from 0) with elements from <code>primes</code>.  The output is:</p>
<pre>
V: [1, 2, 7, 11, 13]
</pre><p>To print the vector, we have used Louis Delacroix' <a href="http://louisdx.github.io/cxx-prettyprint/">cxx-prettyprint</a>, a great tool to easily print STL containers. As you can see, the last three elements have been overwritten. If you had tried to do the same with a destination vector of size 4, this is the surprising end you'd have run into:</p>
<pre>
V: [1, 2, 7, 11]
</pre><p>This is what happens on my architecture (x86_64, with clang 3.2 and gcc 4.8.1 both showing the same result). The standard does not mention whether this is undefined behavior or not, but I find it risky anyway, so I'd rather check the relative sizes before attempting any copy. Again in Josuttis, however, we are said that <em>for <code>copy()</code>, <code>result</code> should not be part of the range [<code>first</code>, <code>last</code>)</em>.</p>
<h3>Using <code>move</code></h3>
<p>You might have noticed that what we are doing is actually moving elements from one container to another. While the <code>copy</code> algorithm uses the copy assignment operator to perform the assignments, we might want to use the <code>move</code> algorithm in order to take advantage of a move assignment operator that the objects in the container might provide. Consider the following trivial code for a <code>struct</code> providing move contructors (I think I got the idea from <a href="http://www.wrox.com/WileyCDA/WroxTitle/Professional-C-2nd-Edition.productCd-0470932449.html">Professional C++</a></p>
<div class="hll"><pre><span></span><span class="k">struct</span> <span class="nc">Moveable</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">Moveable</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">i</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ctor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">Moveable</span><span class="p">(</span><span class="k">const</span> <span class="n">Moveable</span><span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">:</span> <span class="n">i</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;copy ctor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">Moveable</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">Moveable</span><span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span> <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">i</span><span class="p">;</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;copy assignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">Moveable</span><span class="p">(</span><span class="n">Moveable</span><span class="o">&amp;&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">:</span> <span class="n">i</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="n">m</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;move ctor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">Moveable</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Moveable</span><span class="o">&amp;&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
        <span class="n">m</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;move assignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
<p>If we use this class in a <code>copy</code>, we obtain that, during the execution of the algorithm, the copy assignment operator is chosen to perform the assignment.  Using the <code>move</code> algorithm, instead, we use some client code like:</p>
<div class="hll"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Moveable</span><span class="o">&gt;</span> <span class="n">v1</span><span class="p">({</span><span class="n">Moveable</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">Moveable</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">Moveable</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">Moveable</span><span class="p">(</span><span class="mi">7</span><span class="p">)});</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">Moveable</span><span class="o">&gt;</span> <span class="n">v2</span><span class="p">({</span><span class="n">Moveable</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">Moveable</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">Moveable</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="n">Moveable</span><span class="p">(</span><span class="mi">16</span><span class="p">)});</span>
<span class="n">move</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">v1</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">v2</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;v1: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">v1</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;v2: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">v2</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</pre></div>
<p>Our result is the following:</p>
<div class="hll"><pre><span></span><span class="n">ctor</span>
<span class="n">ctor</span>
<span class="n">ctor</span>
<span class="n">ctor</span>
<span class="n">copy</span> <span class="n">ctor</span>
<span class="n">copy</span> <span class="n">ctor</span>
<span class="n">copy</span> <span class="n">ctor</span>
<span class="n">copy</span> <span class="n">ctor</span>
<span class="n">ctor</span>
<span class="n">ctor</span>
<span class="n">ctor</span>
<span class="n">ctor</span>
<span class="n">copy</span> <span class="n">ctor</span>
<span class="n">copy</span> <span class="n">ctor</span>
<span class="n">copy</span> <span class="n">ctor</span>
<span class="n">copy</span> <span class="n">ctor</span>
<span class="n">move</span> <span class="n">assignment</span>
<span class="n">move</span> <span class="n">assignment</span>
<span class="n">move</span> <span class="n">assignment</span>
<span class="n">move</span> <span class="n">assignment</span>
<span class="nl">v1</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="nl">v2</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
</pre></div>
<p>We have: 4 objects constructed in the initializer list, then copied in the vector; this happens for the 2 vectors; then the <code>move</code> algorithm is called, and 4 move assignments are performed. As you see, we have pilfered the values from the vector <code>v1</code>. Not that this was necessary; I think it only makes clear one criterion that should be noted: we use <code>copy</code> to copy elements between containers, but we use <code>move</code> when the elements in the source container are <em>disposable</em>, in the sense that we don't access them after the move.</p>
<h2>Variations</h2>
<p>The <code>copy</code> and <code>move</code> operations come with variants. The variants of copy are:</p>
<ul>
<li><code>copy_if</code></li>
<li><code>copy_backward</code></li>
<li><code>copy_n</code></li>
</ul>
<p>To copy when a condition is verified (determined by a function object), the algorithm with the <code>_if</code> suffix should be used.</p>
<p>If we want, instead, to copy the input range last to first element, we can use the backward version (that has a suffix <code>_backward</code>). One subtlety to which we have to pay attention is the matter of overlapping ranges.  The forward version can be used when the first element in the output sequence comes after the first element in the input sequence. The backward version is to be used whenever this does not hold true.</p>
<p>Finally, the suffix <code>_n</code> version can be used to directly specify the number of elements to be copied, rather than giving the end of the range. For example, we can say:</p>
<div class="hll"><pre><span></span><span class="n">copy_n</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dest</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span>
</pre></div>
<p>instead of specifying the more cumbersome <code>src.begin()+10</code>.</p>
<p>The <code>move</code> algorithm, instead, only offers the variation to move backward, called, indeed, <code>move_backward</code>.</p>
<h2>Summary</h2>
<p>We have started to have a brief look at the the sequence modifying algorithms.  The following is a resume table with the name of the algorithm and a one-line example usage:</p>
<table>
<thead><tr>
<th>Algorithm</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>copy</code></td>
<td>copy(src.begin(), src.end(), dest.begin())</td>
</tr>
<tr>
<td><code>copy_backward</code></td>
<td>copy_backward(src.begin(), src.begin()+4, src.begin()+2)</td>
</tr>
<tr>
<td><code>move</code></td>
<td>move(src.begin(), src.end(), dest.begin())</td>
</tr>
<tr>
<td><code>move_backward</code></td>
<td>move(src.begin(), src.begin()+10, src.begin()+3)</td>
</tr>
<tr>
<td><code>copy_if</code></td>
<td>copy_if(src.begin(), src.end(), dest.begin(), <a href="../../stl-algorithms-part-5/int i"></a>{ return i &gt; 10; })</td>
</tr>
<tr>
<td><code>copy_n</code></td>
<td>copy_n(src.begin(), 10, dest.begin())</td>
</tr>
</tbody>
</table>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../../how-to-use-files-in-c/">How to Use Files in C++</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/increatore">Gian</a>
    
    on 2014-01-27
  </p>
  <p>Recently I've found myself in the common situation where I have to open a file and make something with its content. This is a basic task and should present no difficulties to a programmer; I happened, however, to get stuck for a while in search of a good way to carry out this apparently simple task. In particular, I have run into the recent addition of regular expression processing to the STL. Spoiler alert: I was not particularly happy of what I've found along the way.</p>
<!-- more -->

<h2>Parse a graph data file</h2>
<p>A file with data for a graph can be structured in several ways. I usually try to use the format I've learnt by reading Skiena's book on algorithms and data structures, with a first line containing the number of vertices and of edges, and each subsequent line containing an edge in the form of a source and a destination node. A comment line can be made by starting the line itself with a pound sign.</p>
<p>For example:</p>
<pre>
# Directed graph, 6 vertices, 8 edges
6 8
1 2
2 1
2 3
2 4
3 6
# 4 is source to no destination
5 4
6 4
</pre><p>designates a graph in the form of the following figure:</p>
<p><img src="../../../images/gra.png" alt="Graph from data file"></p>
<h2>Using streams</h2>
<p>The first way I've found to correctly read and parse the file is based on character-by-character reading:</p>
<div class="hll"><pre><span></span><span class="c1">// Using std::istream::get()</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Usage: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; FILENAME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ifstream</span> <span class="n">f</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">.</span><span class="n">good</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Problems opening file &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">first_line</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">V</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">E</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
    <span class="n">stringstream</span> <span class="n">line</span><span class="p">;</span>

    <span class="c1">// This test returns true if the stream is available</span>
    <span class="c1">// for additional reading</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">f</span><span class="p">.</span><span class="n">ignore</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">streamsize</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">(),</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// line ended</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">first_line</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">line</span> <span class="o">&gt;&gt;</span> <span class="n">V</span> <span class="o">&gt;&gt;</span> <span class="n">E</span><span class="p">;</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;V: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">V</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, E: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">E</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
                <span class="n">first_line</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">line</span> <span class="o">&gt;&gt;</span> <span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="n">dest</span><span class="p">;</span>
                <span class="n">add_edge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">line</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">line</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<h3>Using regex</h3>
<p>The second way I've found uses regular expressions. Let's have a look at the code:</p>
<div class="hll"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">V</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">E</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">first_line</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Usage: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; FILENAME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ifstream</span> <span class="n">file</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">good</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Problems opening file &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">regex</span> <span class="n">re</span><span class="p">(</span><span class="s">&quot;(.+) (.+)&quot;</span><span class="p">);</span>

    <span class="k">while</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">good</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">string</span> <span class="n">line</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getline</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">smatch</span> <span class="n">result</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">regex_search</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">regex</span><span class="p">(</span><span class="s">&quot;^#&quot;</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">regex_search</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">re</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No match for &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">line</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_line</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                    <span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                    <span class="n">process_edge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">first_line</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                    <span class="c1">// read number of vertices and edges</span>
                    <span class="n">V</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;V : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">V</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, E: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">E</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>This code only works correctly with the clang compiler, using the clang implementation of the STL (option <code>-stdlib=libc++</code> on Ubuntu). The detail of what happens is the following:</p>
<div class="hll"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">regex</span> <span class="n">re</span><span class="p">(</span><span class="s">&quot;(.+) (.+)&quot;</span><span class="p">);</span>
</pre></div>
<p>This builds the regular expression. I want to match digits in this case, but when I tried with the escape sequence <code>\d</code> instead of the generic dot ("match any character"), I got a warning about <em>unknown escape sequence</em>, even specifying explicitly what is expected to be the default regex grammar, ECMAScript: it can be used as a second parameter to the constructor of the regex:</p>
<div class="hll"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">regex</span> <span class="n">re</span><span class="p">(</span><span class="s">&quot;(.+) (\d+)&quot;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">regex_constants</span><span class="o">::</span><span class="n">ECMAScript</span><span class="p">);</span>
</pre></div>
<p>The second interesting bit is the search:</p>
<div class="hll"><pre><span></span><span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">regex_search</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">regex</span><span class="p">(</span><span class="s">&quot;^#&quot;</span><span class="p">)))</span> <span class="p">{</span>
<span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">regex_search</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">re</span><span class="p">))</span> <span class="p">{</span>
<span class="c1">// ...</span>
</pre></div>
<p>This second one, for example, looks for the regex <code>re</code> in the <code>line</code>, and stores the matching groups (delimited by the parentheses in the regular expression) in a <code>sub_match</code> object, <code>result</code>, that we can later use to initialize the integers. Note the use of the new (in the C++11 sense) functions <code>stoi</code>, that solve the basic problem of converting a numeric string into an integer number.</p>
<p>In this case, as a greater benefit, we can match comments with a pound sign in any point of the line, provided it is the very first character of the line. Compare with what we do in the first example, where we only match the pound if it is in the first column.</p>
<h3>Conclusion</h3>
<p>We have had a look at how to perform a very basic task, namely, opening a file and reading its content line by line, parsing the lines as they come. The support of regular expressions is still very basic (using gcc was impossible), and clang proves to be ahead of the competition. I am an avid user of regex, so I hope that the support will become flawless in a very small time.</p>

  </div>

  

  
  <div class="pagination">
    
      <a href="../3/">&laquo; Previous</a>
    
    | 4 |
    
      <a href="../5/">Next &raquo;</a>
    
  </div>


  </div>
  <footer>
    &copy; Copyright 2021 by Gianluca Ciccarelli.
  </footer>
</body>
